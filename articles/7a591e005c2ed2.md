---
title: "DynamoDB Streamsã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿç¾"
emoji: "ğŸŒ´"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS", "DynamoDB", "EventBridge", "Terraform"]
published: false
---

## ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã¯[dipã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼2025](https://qiita.com/advent-calendar/2025/dip-dev) 16æ—¥ç›®ã®æŠ•ç¨¿ã«ãªã‚Šã¾ã™ï¼

ç§ã¯ã‚¹ãƒãƒƒãƒˆãƒã‚¤ãƒˆãƒ«ã¨ã„ã†ã‚¹ãƒãƒƒãƒˆãƒã‚¤ãƒˆã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆã‚’è»¸ã«ãƒªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã™ã‚‹ãƒãƒ¼ãƒ ã«å±ã—ã¦ã„ã¾ã™ã€‚

ç¾åœ¨ã€ãƒ¢ãƒãƒªã‚·ãƒƒã‚¯ãªã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ã‚¹ãƒˆãƒ©ãƒ³ã‚°ãƒ©ãƒ¼ãƒ•ã‚£ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹æ®µéšçš„ç§»è¡Œã‚’é€²ã‚ã¦ã„ã¾ã™ã€‚
ã“ã®ç§»è¡ŒæœŸé–“ä¸­ã¯æ–°æ—§ä¸¡æ–¹ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãã®ä»•çµ„ã¿ã¨ã—ã¦**DynamoDB Streamsã‚’æ´»ç”¨ã—ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ**ã‚’æ¤œè¨ã—ã¦ãŠã‚Šã¾ã—ãŸã€‚

æœ¬è¨˜äº‹ã§ã¯ã€å‚™å¿˜éŒ²ã¨ã—ã¦ã“ã®åŒæœŸã®ä»•çµ„ã¿ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ï¼

- ãƒªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å…·ä½“çš„ãªå–ã‚Šçµ„ã¿å†…å®¹ã‚„èƒŒæ™¯ãŒæ°—ã«ãªã‚‹æ–¹ã¯ä¸‹è¨˜ã®è¨˜äº‹ã‚’ã”è¦§ãã ã•ã„
https://findy-tools.io/articles/dip-feature-article-2025/168

### å¯¾è±¡èª­è€…

- DynamoDB Streamsã®å®Ÿè·µçš„ãªæ´»ç”¨ä¾‹ã‚’çŸ¥ã‚ŠãŸã„æ–¹
- æ–°æ—§ã‚·ã‚¹ãƒ†ãƒ é–“ã®ãƒ‡ãƒ¼ã‚¿åŒæœŸæ–¹æ³•ã‚’æ¤œè¨ã—ã¦ã„ã‚‹æ–¹

## ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ—§ã‚·ã‚¹ãƒ†ãƒ ï¼ˆBFFå±¤ã¨ã—ã¦æ®‹å­˜ï¼‰                                      â”‚
â”‚ ALB â†’ ECS                                                       â”‚
â”‚ ãƒ»ä¸€éƒ¨ã®å‡¦ç†ã¯ã¾ã è‡ªåˆ†ã§å®Ÿè¡Œ â†’ RDB                                 â”‚
â”‚ ãƒ»ç§»è¡Œæ¸ˆã¿ã®å‡¦ç†ã¯æ–°ã‚·ã‚¹ãƒ†ãƒ ã«å§”è­²                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–°ã‚·ã‚¹ãƒ†ãƒ                                                        â”‚
â”‚ ALB â†’ API Gateway â†’ Lambda â†’ DynamoDB                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“ DynamoDB Streams
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ‡ãƒ¼ã‚¿åŒæœŸå±¤                                                     â”‚
â”‚ EventBridge Pipes â†’ SQS FIFO â†’ VPC Lambda â†’ RDB                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æ–°ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹æ§‹æˆï¼ˆLambda + API Gateway + DynamoDBï¼‰ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚ç§»è¡Œå¯¾è±¡ã®å¢ƒç•Œã¥ã‘ã‚‰ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ•´ç†ã—ãŸçµæœã€ä»¥ä¸‹ã®ç†ç”±ã‹ã‚‰DynamoDBã‚’é¸ã³ã¾ã—ãŸã€‚

- ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ãŒå°‘ãªããƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã®èª²é‡‘ã§ã‚³ã‚¹ãƒˆã‚’æŠ‘ãˆã‚‰ã‚Œã‚‹
- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†…ã§ã®ãƒ†ãƒ¼ãƒ–ãƒ«é–“ã®é€£æºãŒä¸è¦
- Lambdaã¨ã®ç›¸æ€§ãŒè‰¯ã„

### ãªãœã“ã®æ§‹æˆã«ã—ãŸã‹

ã‚¹ãƒˆãƒ©ãƒ³ã‚°ãƒ©ãƒ¼ãƒ•ã‚£ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã§æ®µéšçš„ã«ç§»è¡Œã‚’é€²ã‚ã¦ã„ã‚‹ãŸã‚ã€æ—§ã‚·ã‚¹ãƒ†ãƒ ã®ä¸€éƒ¨æ©Ÿèƒ½ãŒã¾ã RDBã‚’å‚ç…§ã—ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€æ–°ã‚·ã‚¹ãƒ†ãƒ ã§å‡¦ç†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’æ—§ã‚·ã‚¹ãƒ†ãƒ ã®RDBã«æ›¸ãæˆ»ã™å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

ãƒ‡ãƒ¼ã‚¿åŒæœŸã®æ–¹å¼ã¨ã—ã¦æ¤œè¨ã—ãŸé¸æŠè‚¢ã¨ã€æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®äºŒé‡æ›¸ãè¾¼ã¿**
  - æ–°ã‚·ã‚¹ãƒ†ãƒ ãŒæ—§ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¹ã‚­ãƒ¼ãƒã«ä¾å­˜ã—ã¦ã—ã¾ã†ã€‚ã¾ãŸã€2ã¤ã®DBã¸ã®æ›¸ãè¾¼ã¿ã‚’ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ‰±ãˆãªã„
- **ãƒãƒƒãƒåŒæœŸ**
  - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ä»Šå›ã®è¦ä»¶ã«åˆã‚ãªã„

**DynamoDB Streams**ã‚’æ¡ç”¨ã—ãŸç†ç”±ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- æ–°ã‚·ã‚¹ãƒ†ãƒ ãŒæ—§ã‚·ã‚¹ãƒ†ãƒ ã®å­˜åœ¨ã‚’æ„è­˜ã›ãšã«DynamoDBã«æ›¸ãè¾¼ã‚€ã ã‘ã§ã‚ˆã„
- åŒæœŸå‡¦ç†ã‚’åˆ¥ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«åˆ†é›¢ã§ãã‚‹ç–çµåˆãªè¨­è¨ˆ

### ä¿¡é ¼æ€§ã®è¨­è¨ˆ

ã“ã®æ§‹æˆã§ã¯ã€å„å±¤ã«Dead Letter Queueï¼ˆDLQï¼‰ã‚’é…ç½®ã—ã¦éšœå®³ã«å‚™ãˆã¦ã„ã¾ã™ã€‚

- **EventBridge Pipes**: å‡¦ç†å¤±æ•—æ™‚ã‚„ãƒ¬ã‚³ãƒ¼ãƒ‰çµŒéæ™‚é–“è¶…éæ™‚ã«DLQã¸é€€é¿
- **SQS FIFO**: ä¸€å®šå›æ•°ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã‚‚å¤±æ•—ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’DLQã¸é€€é¿

DLQã«æºœã¾ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯CloudWatch Alarmã§æ¤œçŸ¥ã—ã€å¾Œã‹ã‚‰èª¿æŸ»ãƒ»å†å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ä»¥é™ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€å„å±¤ã®å®Ÿè£…ã«ã¤ã„ã¦è©³ã—ãèª¬æ˜ã—ã¾ã™ã€‚

## DynamoDB Streams

DynamoDB Streamsã¯ã€DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å¤‰æ›´ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦ã‚¢ã‚¤ãƒ†ãƒ ã®ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ãŒè¡Œã‚ã‚Œã‚‹ã¨ã€ãã®å¤‰æ›´æƒ…å ±ãŒStreamã«è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚

ä¸»ãªç‰¹å¾´ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- DynamoDBã¸ã®æ›¸ãè¾¼ã¿ã¯è‡ªå‹•çš„ã«Streamã«è¨˜éŒ²ã•ã‚Œã‚‹
- åŒä¸€ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼å†…ã§ã¯å¤‰æ›´ãŒç™ºç”Ÿã—ãŸé †åºã§ã‚¤ãƒ™ãƒ³ãƒˆãŒé…ä¿¡ã•ã‚Œã‚‹
- ã‚¤ãƒ™ãƒ³ãƒˆã¯å°‘ãªãã¨ã‚‚1å›ã¯é…ä¿¡ã•ã‚Œã‚‹ï¼ˆAt-least-onceï¼‰ã€‚é‡è¤‡ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€æ¶ˆè²»å´ã§å†ªç­‰æ€§ã‚’æ‹…ä¿ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- Streamã®ãƒ‡ãƒ¼ã‚¿ã¯24æ™‚é–“ä¿æŒã•ã‚Œã‚‹

### Transactional Outbox Pattern

åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã„ã¦ã€ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ›¸ãè¾¼ã¿ã€ã¨ã€Œã‚¤ãƒ™ãƒ³ãƒˆã®é…ä¿¡ã€ã¨ã„ã†2ã¤ã®æ“ä½œã‚’ç¢ºå®Ÿã«å®Ÿè¡Œã™ã‚‹ã®ã¯é›£ã—ã„å•é¡Œã§ã™ã€‚Transactional Outbox Patternã¯ã€**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ›¸ãè¾¼ã¿ã¨ã‚¤ãƒ™ãƒ³ãƒˆä¿å­˜ã‚’åŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§è¡Œã†**ã“ã¨ã§ã“ã®å•é¡Œã‚’è§£æ±ºã—ã¾ã™ã€‚

DynamoDBã®å ´åˆã€æ¥­å‹™ãƒ‡ãƒ¼ã‚¿ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’åŒä¸€ã‚¢ã‚¤ãƒ†ãƒ ã«ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€ã‚¢ãƒˆãƒŸãƒƒã‚¯ãªæ“ä½œã‚’å®Ÿç¾ã§ãã¾ã™ã€‚æ›¸ãè¾¼ã¿ãŒæˆåŠŸã™ã‚Œã°ã€å¿…ãšDynamoDB Streamsã«ã‚¤ãƒ™ãƒ³ãƒˆãŒæµã‚Œã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¾ã™ã€‚

```json
{
  "order_id": "ORD-20240101-12345",
  "customer_id": 999,
  "order_details": {
    "items": [...],
    "total_amount": 3000,
    "status": "confirmed"
  },
  "event": {
    "event_id": "uuid-2",
    "event_type": "order.confirmed",
    "payload": { ... }
  }
}
```

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ã¯ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ“ä½œã¨ã‚¤ãƒ™ãƒ³ãƒˆã®ä¿å­˜ã‚’ä¸€åº¦ã®æ›¸ãè¾¼ã¿ã§è¡Œã„ã¾ã™ã€‚

```go
// ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ“ä½œã‚’å®Ÿè¡Œ
order.Confirm(confirmParam)

// æ¥­å‹™ãƒ‡ãƒ¼ã‚¿ã¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’åŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ä¿å­˜
// DynamoDBã®å ´åˆã€å˜ä¸€ã‚¢ã‚¤ãƒ†ãƒ ã¸ã®æ›¸ãè¾¼ã¿ã¯ã‚¢ãƒˆãƒŸãƒƒã‚¯
event := order.CreateConfirmedEvent()
repo.SaveWithEvent(ctx, order, event)
```

### Terraformå®šç¾©ä¾‹

```hcl
resource "aws_dynamodb_table" "orders" {
  name             = "orders"
  billing_mode     = "PAY_PER_REQUEST"
  hash_key         = "order_id"
  stream_enabled   = true
  stream_view_type = "NEW_IMAGE"

  attribute {
    name = "order_id"
    type = "S"
  }
}
```

#### è¨­å®šã®ãƒã‚¤ãƒ³ãƒˆ

- `stream_enabled = true`ã§DynamoDB Streamsã‚’æœ‰åŠ¹åŒ–
- `stream_view_type = "NEW_IMAGE"`ã§å¤‰æ›´å¾Œã®ã‚¢ã‚¤ãƒ†ãƒ å…¨ä½“ã‚’Streamã«è¨˜éŒ²

## EventBridge Pipes

EventBridge Pipesã¯ã€AWSã®ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ¥ç¶šã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚ä¸»ãªæ©Ÿèƒ½ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚Šã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚„å¤‰æ›ã‚’è¡Œã£ãŸä¸Šã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«é…ä¿¡
- DynamoDBå›ºæœ‰ã®å‹æƒ…å ±ã‚’å«ã‚€è¤‡é›‘ãªæ§‹é€ ã‚’ã€å…¥åŠ›ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‹ãšã«å¤‰æ›

### å…¥åŠ›ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿å¤‰æ›

DynamoDB Streamsã®å‡ºåŠ›:

```json
{
  "dynamodb": {
    "Keys": {
      "order_id": { "S": "ORD-20240101-12345" }
    },
    "NewImage": {
      "event": {
        "M": {
          "event_type": { "S": "order.confirmed" }
        }
      },
      "customer_id": { "N": "999" },
      "order_details": {
        "M": {
          "total_amount": { "N": "3000" },
          "status": { "S": "confirmed" }
        }
      }
    }
  }
}
```

`M`ã¯Mapå‹ã€`S`ã¯Stringå‹ã€`N`ã¯Numberå‹ã‚’è¡¨ã™DynamoDBå›ºæœ‰ã®å‹æƒ…å ±ã§ã™ã€‚

å¤‰æ›å¾Œ:

```json
{
  "eventType": "order.confirmed",
  "orderID": "ORD-20240101-12345",
  "customerID": "999",
  "orderDetails": {
    "totalAmount": "3000",
    "status": "confirmed"
  }
}
```

å‹æƒ…å ±ãŒé™¤å»ã•ã‚Œã€ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹é€ ã«ãªã‚Šã¾ã—ãŸã€‚

### Terraformå®šç¾©ä¾‹

```hcl
resource "aws_pipes_pipe" "orders" {
  name     = "orders-pipe"
  role_arn = aws_iam_role.pipes_execution_role.arn
  source   = aws_dynamodb_table.orders.stream_arn
  target   = aws_sqs_queue.orders_fifo.arn

  source_parameters {
    dynamodb_stream_parameters {
      batch_size                 = 10
      starting_position          = "TRIM_HORIZON"
      maximum_retry_attempts     = 3
      maximum_record_age_in_seconds = 300

      dead_letter_config {
        arn = aws_sqs_queue.pipes_dlq.arn
      }
    }

    filter_criteria {
      filter {
        pattern = jsonencode({
          dynamodb = {
            NewImage = {
              event = {
                M = {
                  event_id = {
                    S = [{ exists = true }]
                  }
                }
              }
            }
          }
        })
      }
    }
  }

  target_parameters {
    sqs_queue_parameters {
      message_group_id = "$.dynamodb.Keys.order_id.S"
    }

    input_template = <<-JSON
      {
        "eventType": <$.dynamodb.NewImage.event.M.event_type.S>,
        "orderID": <$.dynamodb.Keys.order_id.S>,
        "customerID": "<$.dynamodb.NewImage.customer_id.N>",
        "orderDetails": {
          "totalAmount": "<$.dynamodb.NewImage.order_details.M.total_amount.N>",
          "status": <$.dynamodb.NewImage.order_details.M.status.S>
        }
      }
    JSON
  }
}

resource "aws_sqs_queue" "pipes_dlq" {
  name = "orders-pipes-dlq"
}
```

#### è¨­å®šã®ãƒã‚¤ãƒ³ãƒˆ

- `starting_position = "TRIM_HORIZON"`ã§Streamã«æ®‹ã£ã¦ã„ã‚‹æœ€ã‚‚å¤ã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å‡¦ç†ã‚’é–‹å§‹ã€‚Pipesä½œæˆå‰ã«ç™ºç”Ÿã—ãŸå¤‰æ›´ã‚‚æ¼ã‚Œãªãå‡¦ç†ã§ãã‚‹
- `filter_criteria`ã§`event_id`ãŒå­˜åœ¨ã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’å‡¦ç†å¯¾è±¡ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- `message_group_id`ã«ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ï¼ˆ`order_id`ï¼‰ã‚’æŒ‡å®šã—ã€åŒã˜æ³¨æ–‡ã«å¯¾ã™ã‚‹å¤‰æ›´ã‚’é †åºé€šã‚Šã«å‡¦ç†ï¼ˆç•°ãªã‚‹æ³¨æ–‡é–“ã§ã¯ä¸¦åˆ—å‡¦ç†ãŒå¯èƒ½ï¼‰
- `input_template`ã¯JSONPathå¼ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã€‚æ•°å€¤å‹ï¼ˆ`N`ï¼‰ã®å€¤ã‚’å–å¾—ã™ã‚‹å ´åˆã¯ã€ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚“ã§æ–‡å­—åˆ—ã¨ã—ã¦æ¸¡ã™

## SQS FIFO

SQS FIFOã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é †åºã‚’ä¿è¨¼ã—ã€é‡è¤‡é…ä¿¡ã‚’é˜²ãã‚­ãƒ¥ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚

DynamoDB Streams + EventBridge Pipesã®æ®µéšã§ã¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼å˜ä½ã§é †åºãŒä¿ãŸã‚Œã¦ã„ã¾ã™ãŒã€æ¨™æº–ã‚­ãƒ¥ãƒ¼ã§ã¯å†…éƒ¨ã®åˆ†æ•£ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ç‰¹æ€§ã«ã‚ˆã‚Šé †åºãŒå´©ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã€åŒä¸€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«å¯¾ã™ã‚‹ä¸€é€£ã®å¤‰æ›´ã‚’æ­£ã—ã„é †åºã§æ—§RDBã«åæ˜ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€FIFOã‚­ãƒ¥ãƒ¼ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚

FIFOã‚­ãƒ¥ãƒ¼ã®ãƒ¡ãƒªãƒƒãƒˆã¯é †åºä¿è¨¼ã ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

- **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿æŒæœŸé–“**: SQSã¯æœ€å¤§14æ—¥é–“ä¿æŒã§ãã‚‹ãŸã‚ã€DynamoDB Streamsã®24æ™‚é–“ã¨ã„ã†åˆ¶é™ã‚ˆã‚Šã‚‚é•·ã„çŒ¶äºˆãŒå¾—ã‚‰ã‚Œã‚‹
- **é‡è¤‡æ’é™¤**: `content_based_deduplication`ã«ã‚ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é‡è¤‡é…ä¿¡ã‚’é˜²ã’ã‚‹

### Terraformå®šç¾©ä¾‹

```hcl
resource "aws_sqs_queue" "orders_fifo" {
  name                        = "orders-sync.fifo"
  fifo_queue                  = true
  content_based_deduplication = true
  visibility_timeout_seconds  = 30

  redrive_policy = jsonencode({
    deadLetterTargetArn = aws_sqs_queue.orders_dlq.arn
    maxReceiveCount     = 3
  })
}

resource "aws_sqs_queue" "orders_dlq" {
  name                      = "orders-sync-dlq.fifo"
  fifo_queue                = true
  message_retention_seconds = 1209600  # 14æ—¥é–“
}
```

#### è¨­å®šã®ãƒã‚¤ãƒ³ãƒˆ

- `content_based_deduplication = true`ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ã«åŸºã¥ãé‡è¤‡æ’é™¤ã‚’æœ‰åŠ¹åŒ–
- `message_retention_seconds = 1209600`ã§DLQã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’14æ—¥é–“ä¿æŒ
- `maxReceiveCount = 3`ã§ã€3å›å‡¦ç†ã«å¤±æ•—ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’DLQã«ç§»å‹•

## Lambda

SQS FIFOã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ã—ã€æ—§RDBã«ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã™ã‚‹Lambdaã§ã™ã€‚

### Partial Batch Response

SQSãƒˆãƒªã‚¬ãƒ¼ã®Lambdaã§ã¯ã€è¤‡æ•°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒƒãƒã§å—ã‘å–ã£ã¦å‡¦ç†ã—ã¾ã™ã€‚ãƒãƒƒãƒå†…ã®ä¸€éƒ¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘ãŒå¤±æ•—ã—ãŸå ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒãƒƒãƒå…¨ä½“ãŒå†å‡¦ç†ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

`ReportBatchItemFailures`ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€å¤±æ•—ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã‚’å ±å‘Šã§ãã€æˆåŠŸã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å†å‡¦ç†ã•ã‚Œã¾ã›ã‚“ã€‚

```hcl
resource "aws_lambda_event_source_mapping" "sqs_trigger" {
  event_source_arn                   = aws_sqs_queue.orders_fifo.arn
  function_name                      = aws_lambda_function.sync_to_rdb.arn
  batch_size                         = 10
  maximum_batching_window_in_seconds = 5

  scaling_config {
    maximum_concurrency = 2
  }

  function_response_types = ["ReportBatchItemFailures"]
}
```

Lambdaé–¢æ•°ã§ã¯ã€å¤±æ•—ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®IDã‚’`batchItemFailures`ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚

```go
type SQSBatchResponse struct {
    BatchItemFailures []BatchItemFailure `json:"batchItemFailures"`
}

type BatchItemFailure struct {
    ItemIdentifier string `json:"itemIdentifier"`
}

func Handler(ctx context.Context, event events.SQSEvent) (SQSBatchResponse, error) {
    var failures []BatchItemFailure

    for _, record := range event.Records {
        if err := processMessage(ctx, record); err != nil {
            failures = append(failures, BatchItemFailure{
                ItemIdentifier: record.MessageId,
            })
        }
    }

    return SQSBatchResponse{BatchItemFailures: failures}, nil
}
```

### å†ªç­‰æ€§ã®ä¿è¨¼

Lambdaã®å‡¦ç†ãŒæˆåŠŸã—ã¦ã‚‚ã€SQSã¸ã®å¿œç­”ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹ã¨åŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå†é…ä¿¡ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€å‡¦ç†ã®å†ªç­‰æ€§ã‚’æ‹…ä¿ã—ã¦ãŠãã“ã¨ãŒé‡è¦ã§ã™ã€‚

```go
func ProcessOrderEvent(ctx context.Context, payload *MessagePayload) error {
    tx, err := db.BeginTx(ctx, nil)
    if err != nil {
        return err
    }
    defer func() {
        if err != nil {
            _ = tx.Rollback()
        }
    }()

    switch payload.EventType {
    case "order.created":
        err = insertOrder(ctx, tx, payload)
    case "order.confirmed":
        err = updateOrderStatus(ctx, tx, payload)
    case "order.shipped":
        err = updateOrderShipping(ctx, tx, payload)
    default:
        return nil
    }

    if err != nil {
        return err
    }

    return tx.Commit()
}
```

UPDATEã®å ´åˆã¯å½±éŸ¿ã‚’å—ã‘ãŸè¡Œæ•°ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€INSERTã®å ´åˆã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚„ã‚¤ãƒ™ãƒ³ãƒˆIDã«ã‚ˆã‚‹é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ã“ã¨ã§å†ªç­‰æ€§ã‚’æ‹…ä¿ã—ã¾ã™ã€‚

## ã¾ã¨ã‚

æœ¬è¨˜äº‹ã§ã¯ã€DynamoDB Streamsã‚’æ´»ç”¨ã—ãŸæ–°æ—§ã‚·ã‚¹ãƒ†ãƒ é–“ã®ãƒ‡ãƒ¼ã‚¿åŒæœŸã®ä»•çµ„ã¿ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚

ã“ã®æ§‹æˆã®ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- **ç–çµåˆ**: æ–°ã‚·ã‚¹ãƒ†ãƒ ã¯æ—§ã‚·ã‚¹ãƒ†ãƒ ã®å­˜åœ¨ã‚’æ„è­˜ã›ãšã«DynamoDBã«æ›¸ãè¾¼ã‚€ã ã‘ã§ã‚ˆã„
- **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†**: Transactional Outbox Patternã«ã‚ˆã‚Šã€æ¥­å‹™ãƒ‡ãƒ¼ã‚¿ã¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¢ãƒˆãƒŸãƒƒã‚¯ã«ä¿å­˜
- **çµæœæ•´åˆæ€§**: å³æ™‚æ•´åˆæ€§ã¯ä¸è¦ã¨ã„ã†å‰²ã‚Šåˆ‡ã‚Šã«ã‚ˆã‚Šã€ã‚·ãƒ³ãƒ—ãƒ«ãªéåŒæœŸé€£æºã‚’å®Ÿç¾
- **ç§»è¡Œå®Œäº†å¾Œã«å‰Šé™¤å¯èƒ½**: ãƒ‡ãƒ¼ã‚¿åŒæœŸå±¤ã¯ç§»è¡ŒæœŸé–“é™å®šã®ä»•çµ„ã¿ã¨ã—ã¦ç‹¬ç«‹ã—ã¦ãŠã‚Šã€ç§»è¡Œå®Œäº†å¾Œã¯å‰Šé™¤ã™ã‚‹ã ã‘

æ³¨æ„ç‚¹ã¨ã—ã¦ã€åŒæœŸã«ã¯æ•°ç§’ã®é…å»¶ãŒã‚ã‚‹ãŸã‚ã€å¼·ã„æ•´åˆæ€§ãŒå¿…è¦ãªå ´åˆã¯[Sagaãƒ‘ã‚¿ãƒ¼ãƒ³](https://docs.aws.amazon.com/ja_jp/prescriptive-guidance/latest/modernization-data-persistence/saga-pattern.html)ãªã©ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

## å‚è€ƒè³‡æ–™

- [DynamoDB Streams ã®å¤‰æ›´ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒ—ãƒãƒ£](https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/Streams.html)
- [Amazon EventBridge Pipes](https://docs.aws.amazon.com/ja_jp/eventbridge/latest/userguide/eb-pipes.html)
- [EventBridge Pipes ã®ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ã® DynamoDB ã‚¹ãƒˆãƒªãƒ¼ãƒ ](https://docs.aws.amazon.com/ja_jp/eventbridge/latest/userguide/eb-pipes-dynamodb.html)
- [Transactional Outbox ãƒ‘ã‚¿ãƒ¼ãƒ³](https://docs.aws.amazon.com/ja_jp/prescriptive-guidance/latest/cloud-design-patterns/transactional-outbox.html)
- [ã‚¹ãƒˆãƒ©ãƒ³ã‚°ãƒ©ãƒ¼ãƒ•ã‚£ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³](https://docs.aws.amazon.com/ja_jp/prescriptive-guidance/latest/cloud-design-patterns/strangler-fig.html)
